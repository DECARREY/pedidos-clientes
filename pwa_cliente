<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Pedidos Simple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container-box {
            max-width: 700px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container-box">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">游닍 Crear Nuevo Pedido</h1>
        <p class="mb-6 text-gray-600">Busca tus productos e introduce la cantidad. Tu pedido se enviar치 a nuestro equipo por WhatsApp.</p>

        <script>
            // Cat치logo Simplificado (Solo para mostrar sugerencias)
            const CATALOGO_CLIENTE = [
                { sku: "A0004", name: "Analgesico Forte 500mg", price: 12.50 },
                { sku: "A0025", name: "Vitaminas B12 Complex", price: 45.00 },
                { sku: "A0035", name: "Curitas Adhesivas 50pz", price: 8.75 },
                { sku: "A0050", name: "Term칩metro Digital", price: 98.00 },
                { sku: "B1012", name: "Gasa Esterilizada 10x10", price: 2.10 },
                { sku: "C2020", name: "Mascarilla N95 Negra", price: 15.00 },
                { sku: "D0100", name: "Alcohol Isoprop칤lico 1L", price: 30.00 },
            ];

            function searchProduct(query) {
                const results = CATALOGO_CLIENTE.filter(product => 
                    product.sku.toLowerCase().includes(query.toLowerCase()) || 
                    product.name.toLowerCase().includes(query.toLowerCase())
                );
                renderSuggestions(results);
            }

            function renderSuggestions(results) {
                const list = document.getElementById('suggestions-list');
                list.innerHTML = '';
                if (results.length === 0) {
                    list.classList.add('hidden');
                    return;
                }

                results.forEach(product => {
                    const item = document.createElement('li');
                    item.className = 'p-2 cursor-pointer hover:bg-indigo-50 border-b';
                    item.textContent = `${product.sku} - ${product.name} ($${product.price.toFixed(2)})`;
                    item.onclick = () => {
                        document.getElementById('product-search').value = product.sku;
                        document.getElementById('product-sku').value = product.sku;
                        document.getElementById('product-name').value = product.name;
                        list.classList.add('hidden');
                        document.getElementById('quantity-input').focus();
                    };
                    list.appendChild(item);
                });
                list.classList.remove('hidden');
            }

            function addProductToOrder() {
                const sku = document.getElementById('product-sku').value.toUpperCase();
                const name = document.getElementById('product-name').value;
                const quantity = parseInt(document.getElementById('quantity-input').value);

                if (!sku || isNaN(quantity) || quantity <= 0) {
                    alert("Por favor, selecciona un producto v치lido e introduce una cantidad mayor a cero.");
                    return;
                }

                const tableBody = document.getElementById('order-table-body');

                // Verificar si el SKU ya existe en la tabla (para actualizar cantidad)
                let existingRow = Array.from(tableBody.children).find(row => row.dataset.sku === sku);

                if (existingRow) {
                    let currentQuantity = parseInt(existingRow.dataset.quantity);
                    let newQuantity = currentQuantity + quantity;
                    existingRow.dataset.quantity = newQuantity;
                    existingRow.querySelector('.order-quantity').textContent = newQuantity;
                } else {
                    const row = document.createElement('tr');
                    row.dataset.sku = sku;
                    row.dataset.quantity = quantity;
                    row.className = 'hover:bg-gray-50';

                    row.innerHTML = `
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${sku}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${name}</td>
                        <td class="px-4 py-2 text-sm text-gray-500 order-quantity">${quantity}</td>
                        <td class="px-4 py-2 text-sm text-center">
                            <button onclick="removeRow(this)" class="text-red-600 hover:text-red-900 font-medium">X</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }

                // Limpiar campos y esconder sugerencias
                document.getElementById('product-search').value = '';
                document.getElementById('product-sku').value = '';
                document.getElementById('product-name').value = '';
                document.getElementById('quantity-input').value = 1;
                document.getElementById('suggestions-list').classList.add('hidden');
            }

            function removeRow(button) {
                const row = button.closest('tr');
                row.remove();
            }

            function generatePayloadAndSend() {
                const tableBody = document.getElementById('order-table-body');
                const rows = Array.from(tableBody.children);

                if (rows.length === 0) {
                    alert("Tu pedido est치 vac칤o. Por favor, a침ade al menos un producto.");
                    return;
                }

                const orderData = rows.map(row => {
                    return {
                        // Usamos claves cortas para reducir el tama침o del payload
                        s: row.dataset.sku,      // s: sku
                        q: parseInt(row.dataset.quantity) // q: quantity
                    };
                });

                const jsonString = JSON.stringify(orderData);
                const base64Payload = btoa(unescape(encodeURIComponent(jsonString)));

                // 1. Mensaje de Texto (Simple, para confirmaci칩n visual)
                let textMessage = "춰Hola! He armado un pedido con la herramienta:\n\n";
                rows.forEach(row => {
                    textMessage += `- ${row.dataset.sku} (x${row.dataset.quantity})\n`;
                });
                textMessage += "\nAdjunto el c칩digo para que lo procesen r치pidamente:\n";

                // 2. Mensaje Codificado (La parte vital para el vendedor)
                const encodedMessage = textMessage + 
                                       "[PEDIDO_INICIO]" + 
                                       base64Payload + 
                                       "[PEDIDO_FIN]";

                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(encodedMessage)}`;

                // Abre WhatsApp
                window.open(whatsappUrl, '_blank');
            }

            // Inicializar cantidad a 1
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('quantity-input').value = 1;
            });
        </script>

        <div class="mb-4 relative">
            <label for="product-search" class="block text-sm font-medium text-gray-700">Buscar Producto (SKU o Nombre)</label>
            <input type="text" id="product-search" oninput="searchProduct(this.value)" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Escribe el c칩digo o nombre...">
            <input type="hidden" id="product-sku">
            <input type="hidden" id="product-name">
            <ul id="suggestions-list" class="absolute z-10 w-full bg-white border border-gray-200 mt-1 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                </ul>
        </div>

        <div class="mb-4 flex items-end space-x-3">
            <div class="flex-grow">
                <label for="quantity-input" class="block text-sm font-medium text-gray-700">Cantidad</label>
                <input type="number" id="quantity-input" min="1" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500 text-center" value="1">
            </div>
            <button onclick="addProductToOrder()" class="flex-shrink-0 px-4 py-2 bg-indigo-600 text-white font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                A침adir al Pedido
            </button>
        </div>

        <div class="mb-6 overflow-x-auto shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">SKU</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Descripci칩n</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Cant.</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">Eliminar</th>
                    </tr>
                </thead>
                <tbody id="order-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>

        <button onclick="generatePayloadAndSend()" class="w-full inline-flex items-center justify-center px-4 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0C5.373 0 0 5.373 0 12c0 3.659 1.57 6.945 4.053 9.259L3.06 24l2.25-6.75C6.732 17.5 9.293 18 12 18c6.627 0 12-5.373 12-12S18.627 0 12 0zM12 2c5.523 0 10 4.477 10 10 0 2.923-1.246 5.578-3.238 7.423l-.112.105-1.745-.558c-.52-.166-1.077-.18-1.6-.046-1.577.408-3.28 1.09-5.068 1.09-4.832 0-8.75-3.918-8.75-8.75 0-2.478 1.04-4.707 2.706-6.338l.102-.102L12 2zM7.222 17.151l.519.22c.245.104.51.139.773.104l.112-.012c.265-.035.53-.139.782-.303l.035-.022c.257-.17.472-.407.632-.676l.112-.178c.08-.127.135-.27.165-.418l.006-.035c.03-.148.046-.303.046-.459V10.5c0-.414-.336-.75-.75-.75s-.75.336-.75.75v3.315c0 .35-.078.69-.234 1.01s-.383.606-.656.88l-.203.203c-.273.273-.61.502-.976.685l-.104.054c-.366.183-.75.293-1.139.317l-.208.016c-.147.008-.295-.015-.436-.068z"/>
            </svg>
            Enviar Pedido por WhatsApp
        </button>
    </div>

</body>
</html>
