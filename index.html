<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Productos y Pedidos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de fuentes y tema de Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-gray-700">Cargando aplicación...</p>
        </div>
    </div>

    <!-- Contenedor Principal (Catálogo y Pedido) -->
    <div id="app-container" class="flex flex-col lg:flex-row h-full">

        <!-- Panel de Catálogo (8/12 o 100% en móvil) -->
        <main class="flex-grow p-4 lg:p-8 lg:w-3/5 xl:w-8/12">
            <header class="mb-6 bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
                <h1 class="text-3xl font-bold text-indigo-700">Catálogo de Productos</h1>
                <span id="user-id-display" class="text-sm text-gray-500 hidden lg:block">ID Usuario: Cargando...</span>
            </header>
            
            <!-- Barra de Búsqueda y Filtros -->
            <div class="mb-6 flex flex-col md:flex-row gap-4">
                <input type="text" id="search-input" placeholder="Buscar por Código o Producto..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150 shadow-sm">
                
                <select id="category-filter"
                        class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150 shadow-sm md:w-1/4">
                    <option value="">Todas las Categorías</option>
                    <!-- Las categorías se llenarán con JS -->
                </select>
            </div>

            <!-- Lista de Productos -->
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Tarjetas de productos se insertarán aquí -->
                <p id="no-products" class="hidden col-span-full text-center text-gray-500 text-lg py-10">
                    No se encontraron productos.
                </p>
            </div>
        </main>

        <!-- Panel de Pedido (4/12 o panel deslizable en móvil) -->
        <aside id="order-panel" class="bg-white lg:w-2/5 xl:w-4/12 h-screen-lg p-6 lg:border-l border-gray-200 shadow-xl lg:shadow-none 
                                        fixed top-0 right-0 w-full lg:relative transition-transform duration-300 transform translate-x-full lg:translate-x-0">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-indigo-700">Tu Pedido</h2>
                <button id="close-order-panel" class="lg:hidden p-2 text-gray-500 hover:text-gray-700 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="order-items-list" class="space-y-4 overflow-y-auto max-h-[calc(100vh-200px)] pb-4">
                <p id="empty-cart-message" class="text-gray-500 text-center py-10">
                    El carrito está vacío. Agrega productos.
                </p>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <div class="flex justify-between text-xl font-bold">
                    <span>TOTAL:</span>
                    <span id="order-total" class="text-indigo-600">$0.00</span>
                </div>
            </div>

            <button id="checkout-button" class="w-full mt-6 bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg disabled:opacity-50" disabled>
                Procesar Pedido
            </button>
        </aside>

        <!-- Botón flotante para abrir el panel de pedido en móvil -->
        <button id="open-order-panel" class="fixed bottom-4 right-4 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 z-40 lg:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span id="cart-item-count" class="absolute top-0 right-0 block h-5 w-5 rounded-full ring-2 ring-white bg-red-500 text-xs font-bold text-white text-center leading-5">0</span>
        </button>

    </div>

    <!-- Modal personalizado para mensajes de confirmación/alerta -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-[60] hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition hidden">Cancelar</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Aceptar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firestore
        setLogLevel('Debug');

        // --- Configuración Global de Firebase (MANDATORIA) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- Estado de la Aplicación ---
        const state = {
            products: [],          // Todos los productos del catálogo
            filteredProducts: [],  // Productos mostrados después de la búsqueda/filtro
            order: {},             // El pedido actual: { 'CódigoProducto': cantidad, ... }
        };

        // --- Datos CSV Iniciales (Tu archivo "PRECIOS NORVET 2025F AAP.xlsx - Hoja1.csv") ---
        const csvData = `,,
,Código,Producto,"Precio \npúblico"
,A0003,CEFTRIA-PETS 50 mg NRV 10 ml.,142
,A0004,CEFTRIA-JET 75 mg NRV 20 ml.,205
,A0005,CEFTRIA-JET 75 mg NRV 100 ml.,790
,A0006,CLINDA- JET 100 mg/ml. 25 ml.,435
,A0007,FLOXI-JET 5% INY. NRV. 20 ml.,107
,A0010,FLOXI-JET 10% INY. NRV. 250 ml.,756
,A0015,FLUVI-JET PLUS L.A 6 mill,242
,A0019,GENTA-JET 100 NRV. 100 ml.,429
,A0023,GENTY- JET NRV. 250 ml.,1354
,A0025,OXYJET NRV-50 100 ml.,165
,A0026,OXYJET NRV-50 500 ml.,571
,A0032,TYLO-JET NRV. 250 ml.,676
,A0033,TYLOFOS JET NRV* 1.5   15 ml.,76
,A0034,TYLOFOS JET INY 50 ml. (1ml x 1.5kg),287
,A0035,TYLOFOS JET INY 250 ml. (1ml x 1.5kg),1305
,D0001,DEXA-JET NRV. 100 ml.,150
,D0002,DEXA-JET NRV. 50 ml.,90
,D0003,DEXA-JET L.A. 50 ml.,205
,D0006,FLUNIXIN JET NRV. 100 ml.,195
,D0007,FLUNIXIN JET NRV. 250 ml.,355
,D0010,MELO-JET NRV 50 ml.,228
,D0014,PROT-JET NRV. 100 ml.,266
,D0015,PROT-JET NRV. 250 ml.,492
,D0019,K-DREN NRV. 50 ml.,195
,D0020,K-DREN NRV. 100 ml.,366
,H0001,GLUCOSE-JET NRV. 500 ml.,145
,H0002,AMINO-JET NRV. 500 ml.,135
,H0003,AMINO-JET NRV. 1 lt.,242
,H0004,ELECTRO-JET NRV. 1 lt.,150
,H0005,AMINOSIN NRV. 500 ml.,179
,I0002,ESTRO-JET NRV. 50 ml.,355
,I0003,PROGES-JET NRV. 50 ml.,355
,M0002,HIERRO-JET NRV. 100 ml.,90
,M0003,HIERRO-JET NRV. 250 ml.,160
,M0005,JET-MIN NRV. 250 ml.,179
,M0006,JET-MIN NRV. 500 ml.,315
,M0009,AD3E NRV. 250 ml.,205
,M0011,VIT-AD3E NRV. 100 ml.,165
,M0012,COMPLEJO B NRV. 250 ml.,179
,M0013,COMPLEJO B NRV. 500 ml.,315
,M0016,COMPLEJO B FORTE NRV 100 ml.,185
,M0018,COMPLEJO B FORTE NRV 250 ml.,315
,M0021,COMPLEJO B FORTE NRV 500 ml.,571
,M0025,COMPLEJO B L.A. NRV. 250 ml.,284
,O0001,OTO-PET´S NRV Solución Otica 10 ml.,259
,OF0005,DICLO PET´S NRV,143
,OF0006,PREDNI PET´S NRV oftalmico,158
,OF0008,LUBRI - PET´S NRV Solución Oftalmica 10 ml.,158
,OF0009,LUBRI - PETS UNGÜENTO 7.5 gr.,158
,OF0014,CONDRO PETS LAGRIMA 10 ml,315
,OF0015,TOBRA PETS PLUS 10 ml,560
,S0002,OSO PETS NRV 250 ml.,151
,S0003,OSO PETS NRV 4 lts.,2046
,S0009,FUNGI-PETS OIL NRV 250 ml.,315
,S0011,FUNGI-PETS DRY NRV 250 ml.,315
,S0012,PEROXIBEN PETS NRV 237 ml.,242
,S0013,SARNIPETS NRV 250 ml.,242
,V0002,SEL + E NRV 100 ml.,366
,V0003,SEL + E NRV 250 ml.,778
,V0005,ENER-JET ADE NRV. 100 ml.,284
,V0006,ENER-JET ADE NRV. 500 ml.,1023
,V0010,ENER-JET ADE NRV. 1 lt.,1700
,V0011,B C J NRV. 100 ml.,140
,V0009,ADE NRV. 500 ml.,366
,V0012,B C J NRV. 250 ml.,284
,V0013,B C J NRV. 500 ml.,492
,V0014,B C J NRV. 1 lt.,853`;

        // --- Funciones de Utilidad ---

        /**
         * Muestra el modal personalizado.
         * @param {string} title Título del modal.
         * @param {string} message Mensaje del modal.
         * @param {boolean} isConfirm Si es una confirmación (muestra botón Cancelar).
         * @returns {Promise<boolean>} Resuelve a true si se confirma, false si se cancela.
         */
        function showModal(title, message, isConfirm = false) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const confirmBtn = document.getElementById('modal-confirm-button');
                const cancelBtn = document.getElementById('modal-cancel-button');

                // Mostrar/Ocultar botón de cancelar
                if (isConfirm) {
                    cancelBtn.classList.remove('hidden');
                    confirmBtn.textContent = 'Confirmar';
                } else {
                    cancelBtn.classList.add('hidden');
                    confirmBtn.textContent = 'Aceptar';
                }

                // Limpiar listeners previos
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;

                // Configurar nuevos listeners
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(false);
                };

                // Mostrar modal
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
        }


        /**
         * Convierte el texto CSV en un array de objetos de producto.
         * Esta versión está ajustada para manejar el formato del archivo "PRECIOS NORVET 2025F AAP.xlsx - Hoja1.csv".
         * @param {string} csvText Texto del archivo CSV.
         * @returns {Array<Object>} Lista de productos.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 3) return []; // Necesitamos al menos 3 líneas (una vacía, una de encabezado y una de datos)

            // La línea 1 (índice 1) es el encabezado real: ,Código,Producto,"Precio \npúblico"
            const headerLine = lines[1]; 
            
            // Dividir y limpiar encabezados: ignorar la primera columna vacía (slice(1)) y eliminar comillas/saltos de línea en el título
            const headers = headerLine.split(',').slice(1).map(h => h.trim().replace(/"/g, '').replace(/\s+/g, ' '));
            // headers debería ser: ["Código", "Producto", "Precio público"]

            const dataLines = lines.slice(2); // Los datos comienzan en la línea 3 (índice 2)

            return dataLines.map(line => {
                // Dividir línea de datos e ignorar el primer valor (columna vacía)
                const values = line.split(',').slice(1);
                const product = {};

                if (values.length >= headers.length) {
                    headers.forEach((header, i) => {
                        let value = values[i] ? values[i].trim() : '';
                        
                        // Normalizar el nombre de la columna de precio por si acaso
                        if (header.includes('Precio público')) {
                            product.price = parseFloat(value);
                        } else if (header.includes('Código')) {
                            product.code = value;
                        } else if (header.includes('Producto')) {
                            product.name = value;
                        }
                    });

                    // Añadir una categoría simple basada en el prefijo del código
                    product.category = product.code ? product.code[0] : 'Otros'; 
                }
                // Solo incluir productos con código y un precio válido
                return (product.code && !isNaN(product.price)) ? product : null;
            }).filter(p => p); // Eliminar los valores nulos (productos no válidos)
        }

        /**
         * Formatea un número como moneda.
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2,
            }).format(amount);
        }

        // --- Lógica de Base de Datos (Firestore) ---

        /**
         * Obtiene la referencia al documento del pedido actual del usuario.
         * @returns {import('firebase/firestore').DocumentReference}
         */
        function getCurrentOrderDocRef() {
            if (!userId) {
                console.error("Error: userId no está disponible para obtener la referencia del pedido.");
                return null;
            }
            // Ruta privada para el pedido del usuario: /artifacts/{appId}/users/{userId}/currentOrder/live_order
            return doc(db, 'artifacts', appId, 'users', userId, 'currentOrder', 'live_order');
        }

        /**
         * Obtiene la referencia a la colección pública de productos.
         * @returns {import('firebase/firestore').CollectionReference}
         */
        function getProductsCollectionRef() {
            // Ruta pública para el catálogo: /artifacts/{appId}/public/data/products
            return collection(db, 'artifacts', appId, 'public', 'data', 'products');
        }

        /**
         * Inicializa la colección de productos con los datos CSV si está vacía.
         */
        async function initializeProducts() {
            const productsRef = getProductsCollectionRef();
            try {
                const snapshot = await getDocs(productsRef);
                
                if (snapshot.empty) {
                    console.log("Catálogo de productos vacío. Inicializando con datos CSV...");
                    const parsedProducts = parseCSV(csvData);
                    
                    // Usar Promise.all para subir todos los documentos de forma asíncrona
                    const batchWrites = parsedProducts.map(product => {
                        // Usar setDoc con el código como ID del documento
                        return setDoc(doc(productsRef, product.code), product);
                    });
                    
                    await Promise.all(batchWrites);
                    console.log("Catálogo inicializado con éxito.");
                } else {
                    console.log("Catálogo ya inicializado.");
                }
            } catch (error) {
                console.error("Error al inicializar o verificar el catálogo en Firestore:", error);
            }
        }
        
        // --- Renderizado y Manipulación del DOM ---

        /**
         * Renderiza la lista de productos en el DOM.
         */
        function renderProducts() {
            const listContainer = document.getElementById('product-list');
            const noProductsMsg = document.getElementById('no-products');

            if (state.filteredProducts.length === 0) {
                if (noProductsMsg) noProductsMsg.classList.remove('hidden');
                if (listContainer) listContainer.innerHTML = '';
                return;
            } else {
                if (noProductsMsg) noProductsMsg.classList.add('hidden');
            }

            if (!listContainer) return; // Salir si el contenedor no existe

            listContainer.innerHTML = '';
            
            state.filteredProducts.forEach(product => {
                const isAdded = state.order[product.code] > 0;
                const quantityInCart = state.order[product.code] || 0;

                const cardHtml = `
                    <div class="bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition duration-200 flex flex-col justify-between border-t-4 ${isAdded ? 'border-indigo-500' : 'border-gray-200'}">
                        <div>
                            <span class="text-sm font-medium text-gray-500 bg-indigo-50 px-2 py-0.5 rounded-full">${product.code}</span>
                            <h3 class="text-xl font-semibold text-gray-800 mt-2 truncate" title="${product.name}">${product.name}</h3>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-2xl font-bold text-indigo-600">${formatCurrency(product.price)}</span>
                            ${isAdded ? `
                                <div class="flex items-center space-x-2">
                                    <button data-code="${product.code}" data-action="decrease" 
                                            class="p-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                                    </button>
                                    <span class="font-bold text-lg text-indigo-700">${quantityInCart}</span>
                                    <button data-code="${product.code}" data-action="increase" 
                                            class="p-1 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                    </button>
                                </div>
                            ` : `
                                <button data-code="${product.code}" data-action="add"
                                        class="flex items-center space-x-1 bg-indigo-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-600 transition duration-150 shadow-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    <span>Añadir</span>
                                </button>
                            `}
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Reasignar listeners después de renderizar
            listContainer.querySelectorAll('button[data-code]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const code = e.currentTarget.dataset.code;
                    const action = e.currentTarget.dataset.action;
                    if (action === 'add') {
                        updateOrder(code, (state.order[code] || 0) + 1);
                    } else if (action === 'increase') {
                        updateOrder(code, state.order[code] + 1);
                    } else if (action === 'decrease') {
                        updateOrder(code, state.order[code] - 1);
                    }
                });
            });
        }

        /**
         * Renderiza la lista de artículos del pedido (carrito).
         */
        function renderOrder() {
            const orderList = document.getElementById('order-items-list');
            const orderTotalElement = document.getElementById('order-total');
            const cartItemCount = document.getElementById('cart-item-count');
            const checkoutButton = document.getElementById('checkout-button');
            const emptyCartMessage = document.getElementById('empty-cart-message');

            if (!orderList || !orderTotalElement || !cartItemCount || !checkoutButton || !emptyCartMessage) {
                console.warn("Elementos del carrito no encontrados. Omitiendo renderOrder.");
                return; // Evitar el error de nulidad
            }

            orderList.innerHTML = '';
            
            let total = 0;
            let itemsCount = 0;
            let hasItems = false;

            // Mapeo rápido de códigos a productos completos
            const productMap = state.products.reduce((map, p) => {
                map[p.code] = p;
                return map;
            }, {});

            for (const code in state.order) {
                const quantity = state.order[code];
                const product = productMap[code];

                if (quantity > 0 && product) {
                    hasItems = true;
                    itemsCount += quantity;
                    const subtotal = quantity * product.price;
                    total += subtotal;

                    const itemHtml = `
                        <div class="flex items-center p-3 border border-gray-100 rounded-lg bg-gray-50">
                            <div class="flex-grow">
                                <p class="font-medium text-gray-800">${product.name}</p>
                                <p class="text-sm text-gray-500">${product.code} @ ${formatCurrency(product.price)}</p>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button data-code="${code}" data-action="decrease-cart" 
                                        class="p-1 text-red-500 rounded-full hover:bg-red-50 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                                </button>
                                <span class="font-bold text-md w-6 text-center">${quantity}</span>
                                <button data-code="${code}" data-action="increase-cart" 
                                        class="p-1 text-green-500 rounded-full hover:bg-green-50 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                </button>
                            </div>
                            <span class="font-semibold text-lg ml-4 text-indigo-600 w-20 text-right">${formatCurrency(subtotal)}</span>
                        </div>
                    `;
                    orderList.insertAdjacentHTML('beforeend', itemHtml);
                }
            }

            // Actualizar total y visibilidad del mensaje de carrito vacío
            orderTotalElement.textContent = formatCurrency(total);
            cartItemCount.textContent = itemsCount > 99 ? '99+' : itemsCount.toString();
            cartItemCount.classList.toggle('hidden', itemsCount === 0);
            emptyCartMessage.classList.toggle('hidden', hasItems);
            checkoutButton.disabled = !hasItems;

            // Reasignar listeners para el carrito
            orderList.querySelectorAll('button[data-code]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const code = e.currentTarget.dataset.code;
                    const action = e.currentTarget.dataset.action;
                    if (action === 'increase-cart') {
                        updateOrder(code, state.order[code] + 1);
                    } else if (action === 'decrease-cart') {
                        updateOrder(code, state.order[code] - 1);
                    }
                });
            });

            // El total y el estado del carrito pueden afectar la visualización del catálogo
            renderProducts(); 
        }

        /**
         * Aplica la lógica de búsqueda y filtro a la lista de productos.
         */
        function searchAndFilter() {
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');

            // Comprobación de elementos antes de usar .value
            if (!searchInput || !categoryFilter) return;

            const searchTerm = searchInput.value.toLowerCase().trim();
            const category = categoryFilter.value;
            
            state.filteredProducts = state.products.filter(p => {
                const matchesSearch = p.code.toLowerCase().includes(searchTerm) || 
                                      p.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !category || p.category === category;
                
                return matchesSearch && matchesCategory;
            });
            
            renderProducts();
        }

        // --- Lógica de Pedido (Carrito) ---

        /**
         * Actualiza la cantidad de un producto en el pedido y guarda en Firestore.
         * @param {string} code Código del producto.
         * @param {number} newQuantity Nueva cantidad.
         */
        async function updateOrder(code, newQuantity) {
            const orderDocRef = getCurrentOrderDocRef();
            if (!orderDocRef) return;

            // 1. Actualizar estado local
            if (newQuantity <= 0) {
                delete state.order[code];
            } else {
                state.order[code] = newQuantity;
            }

            // 2. Preparar datos para Firestore: solo el objeto 'order'
            try {
                // Guardar solo los ítems del pedido como un 'map' en Firestore
                await setDoc(orderDocRef, { items: state.order }, { merge: true });
                console.log(`Pedido actualizado: ${code} a ${newQuantity}`);
            } catch (error) {
                console.error("Error al guardar el pedido en Firestore:", error);
                await showModal("Error de Base de Datos", "No se pudo guardar la actualización del pedido. Inténtalo de nuevo.");
            }
        }
        
        // --- Inicialización y Listeners ---

        async function initApp() {
            try {
                // 1. Inicializar Firebase
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } else {
                    console.error("Firebase no configurado. La aplicación funcionará sin persistencia.");
                    // Fallback para pruebas si no hay config
                    state.products = parseCSV(csvData);
                    state.filteredProducts = state.products;
                    // Renderizado inicial sin persistencia:
                    renderProducts(); 
                    renderOrder();
                    document.getElementById('loading-overlay').classList.add('hidden');
                    return;
                }

                // 2. Autenticación
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            // Si no hay usuario, intentar firmar anónimamente o con token
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        
                        // Una vez que el estado de autenticación se ha resuelto
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                        isAuthReady = true;
                        const userIdDisplay = document.getElementById('user-id-display');
                        if (userIdDisplay) userIdDisplay.textContent = `ID Usuario: ${userId}`;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                // 3. Inicializar y Escuchar Datos
                if (isAuthReady) {
                    await initializeProducts();
                    setupFirestoreListeners();
                }

            } catch (error) {
                console.error("Error grave en la inicialización de la aplicación:", error);
                await showModal("Error de Inicialización", "La aplicación no pudo cargar correctamente. Revisa la consola para más detalles.");
            } finally {
                // 4. Asegurar el renderizado inicial (si no se hizo en el fallback)
                if (Object.keys(firebaseConfig).length > 0) {
                    // Cargar productos iniciales del CSV antes de que lleguen de Firestore, para evitar la pantalla blanca.
                    state.products = parseCSV(csvData);
                    state.filteredProducts = state.products;
                    renderProducts();
                    renderOrder();
                }
                
                // 5. Ocultar pantalla de carga
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        /**
         * Configura los listeners de Firestore para productos y el pedido del usuario.
         */
        function setupFirestoreListeners() {
            if (!isAuthReady || !db) {
                console.warn("Firestore no está listo. No se pueden configurar listeners.");
                return;
            }

            // Listener para el catálogo de productos (lectura pública)
            onSnapshot(getProductsCollectionRef(), (snapshot) => {
                const newProducts = [];
                const categories = new Set();
                snapshot.forEach(doc => {
                    const product = doc.data();
                    newProducts.push(product);
                    categories.add(product.category);
                });
                
                state.products = newProducts;
                state.filteredProducts = newProducts;
                
                // Llenar el filtro de categorías
                const filterSelect = document.getElementById('category-filter');
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">Todas las Categorías</option>';
                    Array.from(categories).sort().forEach(cat => {
                        filterSelect.insertAdjacentHTML('beforeend', `<option value="${cat}">${cat} - Categoría</option>`);
                    });
                }


                // Renderizar después de un cambio de datos del catálogo
                searchAndFilter(); 
                renderOrder(); // Asegurar que el carrito se actualice con precios correctos
            }, (error) => {
                console.error("Error al escuchar el catálogo de productos:", error);
            });

            // Listener para el pedido actual del usuario (lectura/escritura privada)
            onSnapshot(getCurrentOrderDocRef(), (docSnapshot) => {
                if (docSnapshot.exists() && docSnapshot.data().items) {
                    // Cargar el objeto de items del documento en el estado del pedido
                    state.order = docSnapshot.data().items;
                } else {
                    // Si el documento no existe o no tiene 'items', el pedido está vacío
                    state.order = {};
                }
                renderOrder(); // Renderizar el carrito con los nuevos datos
            }, (error) => {
                console.error("Error al escuchar el pedido del usuario:", error);
                // Si la primera carga falla, asumir carrito vacío
                state.order = {};
                renderOrder();
            });
        }


        // --- Event Handlers ---

        document.addEventListener('DOMContentLoaded', () => {
            initApp();

            // Evento de Búsqueda
            document.getElementById('search-input')?.addEventListener('input', searchAndFilter);
            
            // Evento de Filtro por Categoría
            document.getElementById('category-filter')?.addEventListener('change', searchAndFilter);

            // Eventos para el panel de pedido (móvil)
            const orderPanel = document.getElementById('order-panel');
            document.getElementById('open-order-panel')?.addEventListener('click', () => {
                orderPanel?.classList.remove('translate-x-full');
            });
            document.getElementById('close-order-panel')?.addEventListener('click', () => {
                orderPanel?.classList.add('translate-x-full');
            });

            // Evento de Procesar Pedido
            document.getElementById('checkout-button')?.addEventListener('click', async () => {
                const itemsInOrder = Object.values(state.order).reduce((sum, qty) => sum + qty, 0);
                const orderTotalElement = document.getElementById('order-total');

                if (itemsInOrder > 0) {
                    const confirmed = await showModal(
                        "Confirmar Pedido",
                        `¿Estás seguro de que deseas procesar este pedido con ${itemsInOrder} artículos por un total de ${orderTotalElement?.textContent || '$0.00'}?`,
                        true
                    );
                    
                    if (confirmed) {
                        // Limpiar el carrito en Firestore (estableciendo un objeto de ítems vacío)
                        await setDoc(getCurrentOrderDocRef(), { items: {} }); 
                        state.order = {}; // Limpiar el estado local
                        await showModal("Pedido Procesado", "¡Tu pedido ha sido procesado con éxito y el carrito ha sido vaciado!");
                        // En un entorno real, aquí se enviarían los datos finales del pedido a un endpoint de servidor.
                    }
                }
            });
        });

    </script>
</body>
</html>
